<div class="appointment-container">
  <div *ngIf="readOnlyMode">
    read
  </div>
  <form nz-form [formGroup]="appointmentFrmGroup">
    <nz-form-item>
      <nz-form-label [nzSpan]="1" class="white-label">姓名</nz-form-label>
      <nz-form-control [nzSpan]="4">
        <nz-select nzShowSearch nzAllowClear nzPlaceHolder="请选择客户" formControlName="customerId"
                   class="customer-selector form-selector" [nzDisabled]="!enableEdit" (focus)="handleFocus($event)">
          <nz-option *ngFor="let customer of customerList" [nzValue]="customer.id"
                     [nzLabel]="customer.name"></nz-option>
        </nz-select>
        <form-field-errors
          [control]="appointmentFrmGroup.get('customerId')"
          [customMessages]="{'required': 'name is required'}">
        </form-field-errors>
      </nz-form-control>
      <nz-form-control [nzSpan]="1"></nz-form-control>
      <nz-form-label [nzSpan]="1">电话</nz-form-label>
      <nz-form-control [nzSpan]="6">
        <input class="appointment-field-input-normal customer-phone" type="text" nz-input formControlName="phone"
               placeholder="电话号" (focus)="handleFocus($event)" [readOnly]="true">
        <form-field-errors
          [control]="appointmentFrmGroup.get('phone')"
          [customMessages]="{'pattern': 'Invalid phone number', 'required': 'Phone number is required'}">
        </form-field-errors>
      </nz-form-control>
      <nz-form-control [nzSpan]="2"></nz-form-control>
      <nz-form-label [nzSpan]="1">项目</nz-form-label>
      <nz-form-control [nzSpan]="6">
        <nz-select nzShowSearch nzAllowClear
                   nzPlaceHolder="请选择项目"
                   class="form-selector"
                   formControlName="treatmentItemId"
                   (focus)="handleFocus($event)"
                   [nzDisabled]="!enableEdit">
          <nz-option *ngFor="let item of treatmentItems" [nzValue]="item.id"
                     [nzLabel]="item.name "></nz-option>
        </nz-select>
        <form-field-errors
          [control]="appointmentFrmGroup.get('treatmentItemId')"
          [customMessages]="{'required': 'treatment item is required'}">
        </form-field-errors>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="2">治疗师</nz-form-label>
      <nz-form-control [nzSpan]="4">
        <nz-select nzShowSearch
                   nzAllowClear
                   nzPlaceHolder="请选择治疗师"
                   formControlName="staffId"
                   class="form-selector staff-selector"
                   (focus)="handleFocus($event)" [nzDisabled]="!enableEdit">
          <nz-option *ngFor="let staff of staffList" [nzValue]="staff.id" [nzLabel]="staff.name "></nz-option>
        </nz-select>
        <form-field-errors
          [control]="appointmentFrmGroup.get('staffId')"
          [customMessages]="{'required': 'staff is required'}">
        </form-field-errors>
      </nz-form-control>

      <nz-form-label [nzSpan]="1">类型</nz-form-label>
      <nz-form-control [nzSpan]="6">
        <nz-select nzShowSearch nzAllowClear nzPlaceHolder="请选择类型" formControlName="type"
                   class="type-selector form-selector" [nzDisabled]="!enableEdit" (focus)="handleFocus($event)">
          <nz-option *ngFor="let type of appointmentTypeList" [nzValue]="type"
                     [nzLabel]="type"></nz-option>
        </nz-select>
        <form-field-errors
          [control]="appointmentFrmGroup.get('type')"
          [customMessages]="{'required': 'type is required'}">
        </form-field-errors>
      </nz-form-control>

      <nz-form-control [nzSpan]="2"></nz-form-control>

      <nz-form-label [nzSpan]="2">首次预约</nz-form-label>
      <nz-form-control [nzSpan]="5">
        <label nz-checkbox formControlName="firstTimeAppointment" [nzDisabled]="!enableEdit"></label>
      </nz-form-control>
    </nz-form-item>


    <nz-form-item>
      <nz-form-label [nzSpan]="1">日期</nz-form-label>
      <nz-form-control [nzSpan]="5">
        <nz-date-picker
          nzFormat="yyyy-MM-dd"
          nzPlaceHolder="日期"
          formControlName="date"
          [(ngModel)]="selectedDate"
          (ngModelChange)="onDateChange($event)"
          (focus)="handleFocus($event)"
          [nzDisabled]="!enableEdit"
        ></nz-date-picker>
      </nz-form-control>


      <nz-form-label [nzSpan]="2">开始时间</nz-form-label>
      <nz-form-control [nzSpan]="4">
        <nz-time-picker
          nzFormat="HH:mm"
          formControlName="startTime"
          nzPlaceHolder="开始时间"
          [nzMinuteStep] ="15"
          [nzDisabledHours]="disabledHours"
          [nzHideDisabledOptions]="true"
          (focus)="handleFocus($event)"
          [nzDisabled]="!enableEdit"
        ></nz-time-picker>
        <form-field-errors
          [control]="appointmentFrmGroup.get('startTime')"
          [customMessages]="{'required': 'startTime is required'}"
        >
        </form-field-errors>
      </nz-form-control>

      <nz-form-label [nzSpan]="2">结束时间</nz-form-label>
      <nz-form-control [nzSpan]="7">
        <nz-time-picker
          nzFormat="HH:mm"
          formControlName="endTime"
          nzPlaceHolder="结束时间"
          [nzMinuteStep] ="15"
          [nzDisabledHours]="disabledHours"
          [nzHideDisabledOptions]="true"
          (focus)="handleFocus($event)"
          [nzDisabled]="!enableEdit"
        ></nz-time-picker>
        <form-field-errors
          [control]="appointmentFrmGroup.get('endTime')"
          [customMessages]="{'required': 'endTime is required'}">
        </form-field-errors>
      </nz-form-control>

    </nz-form-item>


    <nz-form-item>
      <nz-form-label [nzSpan]="4" nzFor="appointmentNote">备注</nz-form-label>
      <nz-form-control [nzSpan]="24">
            <textarea nz-input formControlName="appointmentNote" id="appointmentNote" [readonly]="!enableEdit"
                      (focus)="handleFocus($event)" class="appointment-field-input-normal"> </textarea>
      </nz-form-control>
    </nz-form-item>


    <nz-form-item *ngIf="!enableEdit" class="form-edit">
      <nz-form-control [nzSpan]="9">
      </nz-form-control>
      <button nz-button class="button-width-large" nzType="primary" type="button" (click)="toggleEdit()"
              *ngIf="!readOnlyMode">编辑
      </button>
    </nz-form-item>
    <nz-form-item *ngIf="enableEdit">
      <nz-form-control [nzSpan]="14" [nzOffset]="10">
        <button *ngIf="appointmentFrmGroup.get('appointmentId').value" nz-button class="margin-right-small"
                nzType="default" type="button" (click)="cancelUpdate()">取消
        </button>
        <button *ngIf="!appointmentFrmGroup.get('appointmentId').value" nz-button class="margin-right-small"
                nzType="default" type="button" (click)="close()">取消
        </button>
        <button nz-button nzType="primary" [disabled]="!appointmentFrmGroup.valid" type="button"
                (click)="saveAppointment()">保存
        </button>
        <!--        <button (click)="test()">test</button>-->
      </nz-form-control>
    </nz-form-item>
  </form>


  <div *ngIf="appointmentExist()">
    <div *ngIf="!readOnlyMode">
      <nz-divider></nz-divider>

      <nz-form-item *ngIf="!enableEdit" class="form-edit">
        <nz-form-control [nzSpan]="9">
          <button nz-button class="button-width-large" nzType="primary" type="button" (click)="openPaymentBoard()">预约完成
          </button>
        </nz-form-control>
        <nz-form-control [nzSpan]="6"></nz-form-control>
        <nz-form-control [nzSpan]="9">
          <button nz-button class="button-width-large" nzType="dashed" type="button" nzDanger
                  (click)="cancelAppointment()">取消预约
          </button>
        </nz-form-control>
      </nz-form-item>

      <div *ngIf="showPaymentBoard">
        <nz-divider></nz-divider>
        <h3>请选择付款方式：</h3>
        <nz-radio-group class="margin-top-small">
          <label nz-radio-button nzValue="normalPay" (click)="normalPay()">付款</label>
          <label nz-radio-button nzValue="payByBundlePackage" (click)="bundlePay()">套餐</label>
        </nz-radio-group>
      </div>

      <div class="normal-payment margin-top-small" *ngIf="selectedPaymentMethod==='normal'" [formGroup]="paymentDetailFrmGroup">
        <div class="form-panel payment-detail">
          <div>
            <h3>支付详情</h3>
            <nz-divider></nz-divider>
            <nz-row [nzGutter]="24">
              <div nz-col nzSpan="8">
                <nz-form-item>
                  <nz-form-label>现金</nz-form-label>
                  <nz-form-control>
                    <input nz-input formControlName="cash" placeholder="Enter cash amount"/>
                    <form-field-errors
                      [control]="paymentDetailFrmGroup.get('cash')"
                      [customMessages]="{'required': '必填，没有请填0','pattern': '只能输入数字，支持小数点'}">
                    </form-field-errors>
                  </nz-form-control>
                </nz-form-item>
              </div>
              <div nz-col nzSpan="8">
                <nz-form-item>
                  <nz-form-label>刷卡</nz-form-label>
                  <nz-form-control>
                    <input nz-input formControlName="card" placeholder="Enter card amount"/>
                    <form-field-errors
                      [control]="paymentDetailFrmGroup.get('card')"
                      [customMessages]="{'required': '必填，没有请填0','pattern': '只能输入数字，支持小数点'}">
                    </form-field-errors>
                  </nz-form-control>
                </nz-form-item>
              </div>
              <div nz-col nzSpan="8">
                <nz-form-item>
                  <nz-form-label>转账</nz-form-label>
                  <nz-form-control>
                    <input nz-input formControlName="transfer" placeholder="Enter transfer amount"/>
                    <form-field-errors
                      [control]="paymentDetailFrmGroup.get('transfer')"
                      [customMessages]="{'required': '必填，没有请填0','pattern': '只能输入数字，支持小数点'}">
                    </form-field-errors>
                  </nz-form-control>
                </nz-form-item>
              </div>
            </nz-row>
            <nz-row [nzGutter]="24">
              <div nz-col nzSpan="8">
                <nz-form-item>
                  <nz-form-label>会员卡</nz-form-label>
                  <nz-form-control>
                    <input nz-input formControlName="membershipCard" placeholder="Enter membershipCard amount"/>
                    <form-field-errors
                      [control]="paymentDetailFrmGroup.get('membershipCard')"
                      [customMessages]="{'required': '必填，没有请填0','pattern': '只能输入数字，支持小数点'}">
                    </form-field-errors>
                  </nz-form-control>
                </nz-form-item>
              </div>
              <div nz-col nzSpan="8">
                <nz-form-item>
                  <nz-form-label>保险</nz-form-label>
                  <nz-form-control>
                    <input nz-input formControlName="insurance" placeholder="Enter insurance amount"/>
                    <form-field-errors
                      [control]="paymentDetailFrmGroup.get('insurance')"
                      [customMessages]="{'required': '必填，没有请填0','pattern': '只能输入数字，支持小数点'}">
                    </form-field-errors>
                  </nz-form-control>
                </nz-form-item>
              </div>
              <div nz-col nzSpan="8">
                <nz-form-item>
                  <nz-form-label>人民币</nz-form-label>
                  <nz-form-control>
                    <input nz-input formControlName="rmb" placeholder="Enter rmb amount"/>
                    <form-field-errors
                      [control]="paymentDetailFrmGroup.get('rmb')"
                      [customMessages]="{'required': '必填，没有请填0','pattern': '只能输入数字，支持小数点'}">
                    </form-field-errors>
                  </nz-form-control>
                </nz-form-item>
              </div>
            </nz-row>
          </div>
          <div class="form-actions margin-bottom-small">
            <button nz-button (click)="cancelNormalPay()" nzType="default">取消</button>
            <button nz-button [disabled]="!paymentDetailFrmGroup.valid" (click)="doNormalPay()" nzType="primary">保存
            </button>
          </div>
        </div>
      </div>


      <div class="BundlePackage-payment margin-top-small" *ngIf="selectedPaymentMethod==='bundle'">
        <div class="show-all-bundles margin-bottom-small" *ngIf="!selectePaymentBundle">
          <h4>可用套餐</h4>
          <nz-divider></nz-divider>
          <div class="bundle-list-item" *ngFor="let bundle of customerBundleList; index as i">
            <nz-descriptions nzTitle="可用套餐{{i+1}}" nzBordered ngSkipHydration>
              <nz-descriptions-item nzTitle="套餐名">{{ bundle.bundlePackageName }} test</nz-descriptions-item>
              <nz-descriptions-item nzTitle="购买日期">{{ bundle.purchaseDate }}</nz-descriptions-item>
              <nz-descriptions-item nzTitle="价值">{{ bundle.bundleValue }}</nz-descriptions-item>
              <nz-descriptions-item nzTitle="可用">{{ bundle.active }}</nz-descriptions-item>
              <nz-descriptions-item nzTitle="备注">{{ bundle.bundleNote }}</nz-descriptions-item>
              <nz-descriptions-item nzTitle="套餐内容">
                <div *ngFor="let detail of bundle.packageDetailList">
                  <span> name: {{ detail.treatmentItem.name }}</span><span>remain: {{ detail.remainCount }}</span>
                  <br/>
                </div>
              </nz-descriptions-item>
              <nz-descriptions-item nzTitle="action">
                <button nz-button class="margin-right-small" nzType="primary" type="button"
                        (click)="useBundle(bundle.id)">使用
                </button>
              </nz-descriptions-item>
            </nz-descriptions>
          </div>
          <div *ngIf="noActivePaymentBundle">
          <p>没有可用套餐，请使用付款功能</p>
          </div>
        </div>

        <div class="selected-bundle-board" *ngIf="selectePaymentBundle" >
          <div class="selected-bundle-board" [formGroup]="paymentBundleFrmGroup" >
            <nz-card nzTitle="选择的服务包" class="selected-bundle-card">

              <div formArrayName="packageDetailList">
                <div *ngFor="let detail of packageDetailList.controls; let i = index" [formGroupName]="i">
                  <p>项目: {{detail.get('treatmentItem')?.value.name}}</p>
                  <div class="remaining">
                    <span>剩余次数：</span>
                    <span>{{ detail.get('remainCount')?.value }}</span>
                    <button nz-button class="minus-button" nzType="primary" nzShape="circle" (click)="decreaseRemaining(i)">
                      -
                    </button>
                  </div>
                </div>
              </div>
              <button nz-button nzType="primary" (click)="completeAndPayByBundle()">提交</button>
            </nz-card>
          </div>
        </div>
      </div>
    </div>




    <div *ngIf="readOnlyMode">
      <nz-divider></nz-divider>
      <div *ngIf=" !!appointmentFrmGroup.get('paymentId')?.value">
        <h3>支付详情</h3>
        <br>
        <form [formGroup]="paymentDetailFrmGroup">
          <nz-row [nzGutter]="24">
            <div nz-col nzSpan="8">
              <nz-form-item>
                <nz-form-label>现金r</nz-form-label>
                <nz-form-control>
                  <input nz-input class="readOnly" [readOnly]="!enableEdit" formControlName="cash"
                         placeholder="Enter cash amount" (focus)="handleFocus($event)">
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="8">
              <nz-form-item>
                <nz-form-label>刷卡</nz-form-label>
                <nz-form-control>
                  <input nz-input class="readOnly" [readOnly]="!enableEdit" formControlName="card"
                         placeholder="Enter card amount"/>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="8">
              <nz-form-item>
                <nz-form-label>转账</nz-form-label>
                <nz-form-control>
                  <input nz-input class="readOnly" [readOnly]="!enableEdit" formControlName="transfer"
                         placeholder="Enter transfer amount"/>
                </nz-form-control>
              </nz-form-item>
            </div>
          </nz-row>
          <nz-row [nzGutter]="24">
            <div nz-col nzSpan="8">
              <nz-form-item>
                <nz-form-label>会员卡</nz-form-label>
                <nz-form-control>
                  <input nz-input class="readOnly" [readOnly]="!enableEdit" formControlName="membershipCard"
                         placeholder="Enter membershipCard amount"/>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="8">
              <nz-form-item>
                <nz-form-label>保险</nz-form-label>
                <nz-form-control>
                  <input nz-input class="readOnly" [readOnly]="!enableEdit" formControlName="insurance"
                         placeholder="Enter insurance amount"/>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="8">
              <nz-form-item>
                <nz-form-label>人民币</nz-form-label>
                <nz-form-control>
                  <input nz-input class="readOnly" [readOnly]="!enableEdit" formControlName="rmb"
                         placeholder="Enter rmb amount"/>
                </nz-form-control>
              </nz-form-item>
            </div>
          </nz-row>
        </form>
      </div>
      <div *ngIf=" !appointmentFrmGroup.get('paymentId')?.value && !!appointmentFrmGroup.get('paymentBundle')?.value" >
          <div class="bundle-list-item" >
                      <nz-descriptions nzTitle="使用的套餐" nzBordered ngSkipHydration >
                        <nz-descriptions-item nzTitle="套餐名">{{ bundleReadOnly?.bundlePackageName}}</nz-descriptions-item>
                        <nz-descriptions-item nzTitle="购买日期">{{bundleReadOnly?.purchaseDate}}</nz-descriptions-item>
                        <nz-descriptions-item nzTitle="价值">{{ bundleReadOnly?.bundleValue}}</nz-descriptions-item>
                        <nz-descriptions-item nzTitle="可用">{{ bundleReadOnly?.active}}</nz-descriptions-item>
                        <nz-descriptions-item nzTitle="备注">{{ bundleReadOnly?.bundleNote}}</nz-descriptions-item>
                      </nz-descriptions>
      </div>
    </div>
  </div>

</div>
